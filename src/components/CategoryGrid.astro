---
// src/components/CategoryGrid.astro

const categories = [
  {
    title: 'Budowa',
    heading: 'Budowa domu â€“ koszty, technologie i etapy',
    description: 'Kompleksowe poradniki dotyczÄ…ce budowy domu â€“ od kosztÃ³w budowy domu, przez technologie budowlane, aÅ¼ po materiaÅ‚y i formalnoÅ›ci.',
    href: '/budowa',
    icon: 'ðŸ—ï¸',
    deepLinks: [
      { label: 'Koszt budowy domu', href: '/budowa/koszt-budowy-domu/' },
      { label: 'Technologie budowy', href: '/budowa/technologie-budowy/' },
      { label: 'FormalnoÅ›ci budowlane', href: '/budowa/formalnosci-budowlane/' },
      { label: 'MateriaÅ‚y budowlane', href: '/budowa/materialy-budowlane/' }
    ],
    seoCluster: ['Koszt budowy domu 100 mÂ²', 'Koszt budowy domu systemem gospodarczym', 'Koszt budowy domu pod klucz', 'Budowa domu bez pozwolenia']
  },
  // ... reszta kategorii (Dom, Energia, OgrÃ³d) pozostaje bez zmian
];

// Pobieramy WSZYSTKIE strony raz na gÃ³rze
const allPages = await Astro.glob('../pages/**/*.astro');

function humanizeFileName(fn) {
  return fn
    .replace(/\.astro$/i, '')
    .replace(/index$/i, '')
    .replace(/[-_]+/g, ' ')
    .trim()
    .replace(/\b\w/g, c => c.toUpperCase());
}

import { pillarMeta } from '../data/koszt-budowy-domu-breadcrumbs.js';

// Funkcja pomocnicza do filtrowania linkÃ³w
const getAutoLinks = (categoryHref) => {
  const folder = categoryHref.replace(/^\//, '').replace(/\/$/, '');
  if (!folder) return [];

  return allPages
    .filter(page => {
      const isInternal = page.file.includes(`/src/pages/${folder}/`);
      const isNotIndex = !page.file.endsWith('index.astro');
      return isInternal && isNotIndex;
    })
    .map(page => {
      // PrÃ³ba pobrania tytuÅ‚u z breadcrumbs (jeÅ›li istniejÄ… w frontmatter) lub tytuÅ‚u gÅ‚Ã³wnego
      let title = page.frontmatter?.title;
      
      // JeÅ›li masz breadcrumbs w frontmatter jako tablicÄ™:
      if (page.frontmatter?.breadcrumbs?.[3]?.label) {
        title = page.frontmatter.breadcrumbs[3].label;
      }

      const href = page.url || page.file.replace(/.*\/pages/, '').replace(/\.astro$/, '').replace(/\/index$/, '');
      
      return { 
        title: title || humanizeFileName(page.file.split(/[\\\/]/).pop()),
        href: href 
      };
    })
    .slice(0, 4);
};

// Mapujemy kategorie dodajÄ…c linki
const categoriesWithLinks = categories.map(cat => ({
  ...cat,
  autoLinks: getAutoLinks(cat.href)
}));
---

<div class="space-y-12">
  {categoriesWithLinks.map((category) => (
    <div class="border-l-4 border-orange-500 pl-6">
      {category.title === 'Budowa' && (
        <div class="mb-6 grid grid-cols-1 md:grid-cols-3 gap-4 items-stretch">
          <a href={pillarMeta.href} class="md:col-span-1 block rounded-lg overflow-hidden shadow hover:shadow-lg transition-shadow bg-white">
            <img src={pillarMeta.image} alt={pillarMeta.title} class="w-full h-40 object-cover" />
          </a>
          <div class="md:col-span-2 bg-white rounded-lg p-6 shadow-sm">
            <a href={pillarMeta.href} class="text-sm text-orange-500 font-semibold">Budowa</a>
            <h3 class="text-2xl font-bold text-zinc-800 mt-2 mb-3"><a href={pillarMeta.href} class="hover:text-orange-500">{pillarMeta.title}</a></h3>
            <p class="text-zinc-600 mb-4">{pillarMeta.description}</p>
            <a href={pillarMeta.href} class="inline-block bg-orange-500 text-white px-4 py-2 rounded-lg hover:bg-orange-600">PrzejdÅº do przewodnika</a>
          </div>
        </div>
      )}
      <a href={category.href} class="group block mb-6">
        <div class="text-4xl mb-3">{category.icon}</div>
        <h2 class="text-2xl font-bold text-zinc-700 mb-3 group-hover:text-orange-500 transition-colors">
          {category.heading}
        </h2>
        <p class="text-zinc-600 mb-4 leading-relaxed">
          {category.description}
        </p>
      </a>

      <div class="mb-6">
        <p class="text-xs font-bold text-zinc-600 mb-3 uppercase">Podlinkowane tematy:</p>
        <div class="flex flex-wrap gap-2">
          {category.deepLinks.map((link) => (
            <a href={link.href} class="text-sm text-orange-500 hover:text-orange-600 hover:underline transition-colors">
              {link.label}
            </a>
          ))}
        </div>
      </div>

      <div class="bg-stone-100 rounded-lg p-4">
        <p class="text-xs font-bold text-zinc-600 mb-3 uppercase">NajczÄ™Å›ciej wyszukiwane:</p>
        <ul class="space-y-2">
          {category.autoLinks && category.autoLinks.length > 0 ? (
            category.autoLinks.map(link => (
              <li>
                <a href={link.href} class="text-sm text-zinc-600 hover:text-orange-500 hover:underline">
                  â†’ {link.title}
                </a>
              </li>
            ))
          ) : (
            category.seoCluster.map((term) => (
              <li>
                <span class="text-sm text-zinc-600">â†’ {term}</span>
              </li>
            ))
          )}
        </ul>
      </div>
    </div>
  ))}
</div>