---
// Importy na samej gÃ³rze
import { pillarMeta } from '../data/koszt-budowy-domu-breadcrumbs.js';

const categories = [
  {
    title: 'Budowa',
    heading: 'Budowa domu â€“ koszty, technologie i etapy',
    description: 'Kompleksowe poradniki dotyczÄ…ce budowy domu â€“ od kosztÃ³w budowy domu, przez technologie budowlane, aÅ¼ po materiaÅ‚y i formalnoÅ›ci.',
    href: '/budowa',
    icon: 'ðŸ—ï¸',
    deepLinks: [
      { label: 'Koszt budowy domu', href: '/budowa/koszt-budowy-domu/' },
      { label: 'Technologie budowy', href: '/budowa/technologie-budowy/' },
      { label: 'FormalnoÅ›ci budowlane', href: '/budowa/formalnosci-budowlane/' },
      { label: 'MateriaÅ‚y budowlane', href: '/budowa/materialy-budowlane/' }
    ],
    seoCluster: ['Koszt budowy domu 100 mÂ²', 'Koszt budowy domu systemem gospodarczym', 'Koszt budowy domu pod klucz', 'Budowa domu bez pozwolenia']
  }
  // Dodaj resztÄ™ kategorii tutaj...
];

// 1. Bezpieczne pobieranie moduÅ‚Ã³w
const modules = import.meta.glob('/src/pages/**/*.astro', { eager: true });

// 2. Funkcja pomocnicza - upewnij siÄ™, Å¼e nie uÅ¼ywasz w niej "i" jako zmiennej globalnej
function humanizeFileName(fn: string) {
  if (!fn) return '';
  return fn
    .replace(/\.astro$/i, '')
    .replace(/index$/i, '')
    .replace(/[-_]+/g, ' ')
    .trim()
    .replace(/\b\w/g, (char) => char.toUpperCase()); // Zmieniono 'c' na 'char' dla jasnoÅ›ci
}

// 3. Przetwarzanie stron
const allPages = Object.keys(modules).map(p => {
  const mod = modules[p] as any;
  return {
    file: p,
    title: mod?.frontmatter?.title,
    breadcrumbLabel: mod?.frontmatter?.breadcrumbs?.[3]?.label,
    url: mod?.url
  };
});

const getAutoLinks = (categoryHref: string) => {
  const folder = categoryHref.replace(/^\//, '').replace(/\/$/, '');
  if (!folder) return [];

  return allPages
    .filter(page => {
      const isInFolder = page.file.includes(`/src/pages/${folder}/`);
      const isNotIndex = !page.file.endsWith('index.astro');
      return isInFolder && isNotIndex;
    })
    .map(page => {
      // Logika wyboru tytuÅ‚u
      const finalTitle = page.breadcrumbLabel || page.title || humanizeFileName(page.file.split('/').pop() || '');
      
      // Logika wyboru URL
      const finalHref = page.url || page.file.replace('/src/pages', '').replace('.astro', '').replace(/\/index$/, '');

      return { title: finalTitle, href: finalHref };
    })
    .slice(0, 4);
};

const categoriesWithLinks = categories.map(cat => ({
  ...cat,
  autoLinks: getAutoLinks(cat.href)
}));
---

<div class="space-y-12">
  {categoriesWithLinks.map((category) => (
    <div class="border-l-4 border-orange-500 pl-6">
      {category.title === 'Budowa' && (
        <div class="mb-6 grid grid-cols-1 md:grid-cols-3 gap-4 items-stretch">
          <a href={pillarMeta.href} class="md:col-span-1 block rounded-lg overflow-hidden shadow hover:shadow-lg transition-shadow bg-white">
            <img src={pillarMeta.image} alt={pillarMeta.title} class="w-full h-56 object-cover object-center" />
          </a>
          <div class="md:col-span-2 bg-white rounded-lg p-6 shadow-sm">
            <a href={pillarMeta.href} class="text-sm text-orange-500 font-semibold">Budowa</a>
            <h3 class="text-2xl font-bold text-zinc-800 mt-2 mb-3">
               <a href={pillarMeta.href} class="hover:text-orange-500">{pillarMeta.title}</a>
            </h3>
            <p class="text-zinc-600 mb-4">{pillarMeta.description}</p>
            <a href={pillarMeta.href} class="inline-block bg-orange-500 text-white px-4 py-2 rounded-lg hover:bg-orange-600">
               PrzejdÅº do przewodnika
            </a>
          </div>
        </div>
      )}

      <a href={category.href} class="group block mb-6">
        <div class="text-4xl mb-3">{category.icon}</div>
        <h2 class="text-2xl font-bold text-zinc-700 mb-3 group-hover:text-orange-500 transition-colors">
          {category.heading}
        </h2>
        <p class="text-zinc-600 mb-4 leading-relaxed">
          {category.description}
        </p>
      </a>

      <div class="mb-6">
        <p class="text-xs font-bold text-zinc-600 mb-3 uppercase">Podlinkowane tematy:</p>
        <div class="flex flex-wrap gap-4">
          {category.deepLinks.map((link) => (
            <a href={link.href} class="text-sm text-orange-500 hover:text-orange-600 hover:underline transition-colors font-medium">
              {link.label}
            </a>
          ))}
        </div>
      </div>

      <div class="bg-stone-50 rounded-lg p-5 border border-stone-200">
        <p class="text-xs font-bold text-zinc-500 mb-3 uppercase tracking-wider">NajczÄ™Å›ciej wyszukiwane:</p>
        <ul class="grid grid-cols-1 md:grid-cols-2 gap-2">
          {category.autoLinks && category.autoLinks.length > 0 ? (
            category.autoLinks.map(link => (
              <li>
                <a href={link.href} class="text-sm text-zinc-600 hover:text-orange-500 flex items-center gap-2">
                  <span class="text-orange-400">â†’</span> {link.title}
                </a>
              </li>
            ))
          ) : (
            category.seoCluster.map((term) => (
              <li class="flex items-center gap-2 text-sm text-zinc-500">
                <span class="text-stone-300">â†’</span> {term}
              </li>
            ))
          )}
        </ul>
      </div>
    </div>
  ))}
</div>