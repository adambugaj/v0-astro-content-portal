---
const { editors = [] } = Astro.props;

const defaultEditors = [
  {
    name: 'Dariusz Nowicki',
    title: 'Redaktor Naczelny',
    href: '/o-redakcji#dariusz-nowicki'
  },
  {
    name: 'Monika Zielińska',
    title: 'Zastępca Redaktora',
    href: '/o-redakcji#monika-zielinska'
  }
];

// Detect category from URL
const currentPath = Astro.url.pathname;
const category = currentPath.split('/')[1];

// Helper: humanize filename -> Title
function humanizeFileName(fn: string) {
  const s = String(fn || '')
    .replace(/\.astro$/i, '')
    .replace(/index$/i, '')
    .replace(/[-_]+/g, ' ')
    .replace(/\b(koszt|budowy|domu)\b/gi, '')
    .trim();
  return s.replace(/\b\w/g, (c: string) => c.toUpperCase());
}

let articles = [];

  if (category === 'budowa') {
  // Dynamically load supporting pages for the budowa/koszt-budowy-domu pillar (import.meta.glob eager)
  const pageModules = import.meta.glob('/src/pages/budowa/koszt-budowy-domu/*.astro', { eager: true }) as Record<string, any>;
  const pages = Object.keys(pageModules).map(p => ({ file: p, module: pageModules[p] }));
  // Build articles list, preferring `breadcrumbs[0].label` exported from each page module
  articles = [];
    for (const p of pages) {
      if (/index\.astro$/i.test(p.file)) continue;
      const href = (p.file.replace(/.*[\\\/]src[\\\/]pages/, '')).replace(/index\.astro$/i, '').replace(/\.astro$/i, '') || '/';
      let title = (p.module?.frontmatter?.title) || humanizeFileName(String(p.file.split(/[\\\/]/).pop()));
      try {
        const crumbs = p.module?.breadcrumbs;
        if (Array.isArray(crumbs) && crumbs.length) {
          const last = crumbs[crumbs.length - 1];
          if (last && last.label) title = last.label;
        }
      } catch (err) {
        // swallow errors and keep fallback title
      }
      articles.push({ title, href });
    }
  articles = articles.slice(0, 10);
  } else {
  // Fallback static lists for other categories
  const relatedArticles = {
    energia: [
      { title: 'Instalacja fotowoltaiczna', href: '/energia/fotowoltaika' },
      { title: 'Pomp ciepła - jak działają', href: '/energia/pompy-ciepla' },
      { title: 'Kolektory słoneczne', href: '/energia/kolektory-sloneczne' }
    ],
    wnetrza: [
      { title: 'Nowe trendy w aranżacji', href: '/wnetrza/trendy-2026' },
      { title: 'Kolory tego sezonu', href: '/wnetrza/kolory' },
      { title: 'Meble ergonomiczne', href: '/wnetrza/meble' }
    ],
    ogrod: [
      { title: 'Rośliny do ogrodu', href: '/ogrod/rosliny' },
      { title: 'Automatyczne podlewanie', href: '/ogrod/podlewanie' },
      { title: 'Oświetlenie ogrodu', href: '/ogrod/oswietlenie' }
    ]
  };
  articles = (relatedArticles as any)[category] || [];
}

const displayEditors = editors.length > 0 ? editors : defaultEditors;
---

<aside class="space-y-6 article-sidebar w-full lg:w-80 flex-shrink-0">
  <div class="lg:sticky lg:top-16 lg:self-start space-y-6">
  <!-- Table of Contents -->
    <div class="bg-white border border-stone-300 rounded-xl p-6">
    <h3 class="text-lg font-bold text-zinc-700 mb-4">Spis treści</h3>
    <nav id="toc-nav" class="space-y-2 text-sm">
      <!-- JavaScript will populate this -->
    </nav>
  </div>

  <!-- Related Articles -->
  <div class="bg-stone-50 border border-stone-300 rounded-xl p-6">
    <h3 class="text-lg font-bold text-zinc-700 mb-4">Powiązane artykuły</h3>
    <div class="space-y-3">
      {category === 'budowa' && (
        <a href="/budowa/koszt-budowy-domu" class="block text-sm font-semibold text-orange-600 hover:text-orange-700 mb-2">
          → Główny przewodnik: Koszt Budowy Domu
        </a>
      )}
      {articles.map((article: any) => (
        <a href={article.href} class="block text-sm text-zinc-700 hover:text-orange-500 font-medium transition-colors">
          → {article.title}
        </a>
      ))}
    </div>
  </div>

  <!-- Editors Section (Minimalist) -->
  <div class="bg-white border border-stone-300 rounded-xl p-6">
    <h3 class="text-lg font-bold text-zinc-700 mb-4 border-b border-stone-300 pb-3">Redaktorzy</h3>
    <div class="space-y-3">
      {displayEditors.map((editor: any) => (
        <a href={editor.href} class="flex items-center gap-3 hover:opacity-75 transition-opacity">
          {editor.name === 'Dariusz Nowicki' && (
            <div class="w-10 h-10 rounded-full bg-gradient-to-br from-zinc-600 to-zinc-800 flex items-center justify-center text-white text-xs font-bold flex-shrink-0">
              DN
            </div>
          )}
          {editor.name === 'Monika Zielińska' && (
            <div class="w-10 h-10 rounded-full bg-gradient-to-br from-orange-400 to-orange-600 flex items-center justify-center text-white text-xs font-bold flex-shrink-0">
              MZ
            </div>
          )}
          <div class="min-w-0">
            <p class="text-sm font-bold text-zinc-700">{editor.name}</p>
            <p class="text-xs text-zinc-500">{editor.title}</p>
          </div>
        </a>
      ))}
    </div>
    <a href="/o-redakcji" class="block text-center text-xs text-orange-500 hover:text-orange-600 font-semibold mt-4 pt-3 border-t border-stone-300">
      Poznaj całą redakcję →
    </a>
  </div>
</aside>

<script>
  // Generate Table of Contents from article headings
  document.addEventListener('DOMContentLoaded', () => {
    const article = document.querySelector('article');
    const tocNav = document.getElementById('toc-nav');
    
    if (article && tocNav) {
      const headings = article.querySelectorAll('h2, h3');
      const tocItems: string[] = [];
      
      headings.forEach((heading, index) => {
        const id = heading.id || `heading-${index}`;
        if (!heading.id) heading.id = id;
        
        const level = heading.tagName === 'H2' ? '' : 'ml-3';
        const text = heading.textContent || '';
        
        tocItems.push(`
          <a href="#${id}" class="block py-1 text-zinc-600 hover:text-orange-500 transition-colors ${level}">
            ${text}
          </a>
        `);
      });
      
      tocNav.innerHTML = tocItems.join('');
    }
  });
</script>
